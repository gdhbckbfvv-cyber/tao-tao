# åœ°çƒæ–°ä¸» - ç™»å‡ºåŠŸèƒ½å®Œæ•´è¯´æ˜

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. ProfileTabViewï¼ˆä¸ªäººé¡µé¢ï¼‰

**å¯¼å…¥æ¨¡å—ï¼š**
```swift
import SwiftUI
import Supabase  // âœ… è®¿é—® User ç±»å‹
```

**ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼š**
- âœ… å¤´åƒï¼ˆåœ†å½¢æ¸å˜ï¼Œæ©™è‰²ä¸»é¢˜ï¼‰
- âœ… ç”¨æˆ·åï¼ˆé»˜è®¤æ˜¾ç¤º"å¹¸å­˜è€…"ï¼‰
- âœ… é‚®ç®±åœ°å€
- âœ… æ³¨å†Œæ—¶é—´

**é€€å‡ºç™»å½•æŒ‰é’®ï¼š**
- âœ… çº¢è‰²æŒ‰é’®ï¼Œå›¾æ ‡ + æ–‡å­—
- âœ… ç‚¹å‡»åæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
- âœ… ç¡®è®¤åè°ƒç”¨ `authManager.signOut()`
- âœ… æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆè½¬åœˆ + "é€€å‡ºä¸­..."ï¼‰
- âœ… ç™»å‡ºæœŸé—´æŒ‰é’®ç¦ç”¨ï¼Œé€æ˜åº¦é™ä½

**é”™è¯¯å¤„ç†ï¼š**
- âœ… å¦‚æœç™»å‡ºå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ Toast
- âœ… Toast 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
- âœ… é”™è¯¯ä¿¡æ¯åŒ…å«å…·ä½“åŸå› 

### 2. AuthManager.signOut() æ–¹æ³•

**å®Œæ•´æµç¨‹ï¼š**
```swift
func signOut() async {
    isLoading = true
    print("ğŸšª å¼€å§‹é€€å‡ºç™»å½•...")

    do {
        // 1. è°ƒç”¨ Supabase ç™»å‡º API
        try await supabase.auth.signOut()
        print("âœ… é€€å‡ºç™»å½•æˆåŠŸ")

        // 2. æ¸…ç©ºæ‰€æœ‰æœ¬åœ°çŠ¶æ€
        isAuthenticated = false       // è§¦å‘é¡µé¢è·³è½¬
        needsPasswordSetup = false
        currentUser = nil
        otpSent = false
        otpVerified = false
        errorMessage = nil
    } catch {
        // 3. é”™è¯¯å¤„ç†
        print("âŒ é€€å‡ºç™»å½•å¤±è´¥: \(error.localizedDescription)")
        errorMessage = "é€€å‡ºç™»å½•å¤±è´¥: \(error.localizedDescription)"
    }

    isLoading = false
}
```

**æ•ˆæœï¼š**
1. âœ… æ¸…é™¤æœåŠ¡å™¨ç«¯ä¼šè¯
2. âœ… æ¸…é™¤æœ¬åœ°æ‰€æœ‰è®¤è¯çŠ¶æ€
3. âœ… å°† `isAuthenticated` è®¾ä¸º `false`
4. âœ… EarthLordApp ç›‘å¬åˆ°å˜åŒ–ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

### 3. ä¼šè¯è¿‡æœŸè‡ªåŠ¨å¤„ç†

**ç›‘å¬æœºåˆ¶ï¼š**
```swift
// AuthManager åˆå§‹åŒ–æ—¶å¯åŠ¨ç›‘å¬
init(supabase: SupabaseClient) {
    self.supabase = supabase
    Task {
        await observeAuthStateChanges()
    }
}

// æŒç»­ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
private func observeAuthStateChanges() async {
    for await (event, session) in supabase.auth.authStateChanges {
        handleAuthStateChange(event: event, session: session)
    }
}
```

**å¤„ç†ä¼šè¯è¿‡æœŸï¼š**
```swift
private func handleAuthStateChange(event: AuthChangeEvent, session: Session?) {
    print("ğŸ” è®¤è¯çŠ¶æ€å˜åŒ–: \(event)")

    switch event {
    case .signedOut:
        // ç”¨æˆ·ç™»å‡ºï¼ˆåŒ…æ‹¬ä¸»åŠ¨ç™»å‡ºå’Œä¼šè¯è¿‡æœŸï¼‰
        print("âš ï¸ ç”¨æˆ·å·²ç™»å‡º")
        isAuthenticated = false       // è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
        needsPasswordSetup = false
        currentUser = nil
        otpSent = false
        otpVerified = false
        errorMessage = nil

    case .tokenRefreshed:
        // Token è‡ªåŠ¨åˆ·æ–°ï¼ˆæ— éœ€ç”¨æˆ·æ“ä½œï¼‰
        print("ğŸ”„ Token å·²åˆ·æ–°")
        break

    // ... å…¶ä»–äº‹ä»¶å¤„ç†
    }
}
```

**ä¼šè¯è¿‡æœŸæµç¨‹ï¼š**
```
1. Supabase Access Token è¿‡æœŸï¼ˆé»˜è®¤ 1 å°æ—¶ï¼‰
   â†“
2. Supabase SDK å°è¯•ç”¨ Refresh Token åˆ·æ–°
   â†“
3a. åˆ·æ–°æˆåŠŸ â†’ è§¦å‘ .tokenRefreshed äº‹ä»¶ â†’ ç”¨æˆ·æ— æ„ŸçŸ¥ç»§ç»­ä½¿ç”¨
   â†“
3b. Refresh Token ä¹Ÿè¿‡æœŸï¼ˆé»˜è®¤ 7 å¤©ï¼‰â†’ è§¦å‘ .signedOut äº‹ä»¶
   â†“
4. handleAuthStateChange() ç›‘å¬åˆ° .signedOut
   â†“
5. è®¾ç½® isAuthenticated = false
   â†“
6. EarthLordApp ç›‘å¬åˆ°å˜åŒ–ï¼Œè‡ªåŠ¨æ˜¾ç¤º AuthViewï¼ˆç™»å½•é¡µï¼‰
```

## ğŸ“± ç”¨æˆ·æ“ä½œæµç¨‹

### ä¸»åŠ¨ç™»å‡º
```
ç”¨æˆ·ç‚¹å‡»"é€€å‡ºç™»å½•"
  â†“
æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  â†“
ç”¨æˆ·ç¡®è®¤
  â†“
æŒ‰é’®æ˜¾ç¤º"é€€å‡ºä¸­..."ï¼ˆç¦ç”¨çŠ¶æ€ï¼‰
  â†“
è°ƒç”¨ authManager.signOut()
  â†“
Supabase æ¸…é™¤ä¼šè¯
  â†“
è§¦å‘ .signedOut äº‹ä»¶
  â†“
isAuthenticated = false
  â†“
è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µï¼ˆæ·¡å…¥æ·¡å‡ºåŠ¨ç”» 0.3ç§’ï¼‰
```

### ä¼šè¯è‡ªåŠ¨è¿‡æœŸ
```
ç”¨æˆ·æ­£åœ¨ä½¿ç”¨ App
  â†“
Access Token è¿‡æœŸï¼ˆ1å°æ—¶åï¼‰
  â†“
Supabase SDK è‡ªåŠ¨å°è¯•åˆ·æ–°
  â†“
Refresh Token æœ‰æ•ˆ â†’ åˆ·æ–°æˆåŠŸ â†’ ç”¨æˆ·æ— æ„ŸçŸ¥
  â†“
Refresh Token ä¹Ÿè¿‡æœŸï¼ˆ7å¤©åï¼‰â†’ åˆ·æ–°å¤±è´¥
  â†“
Supabase è§¦å‘ .signedOut äº‹ä»¶
  â†“
AuthManager ç›‘å¬åˆ°äº‹ä»¶
  â†“
isAuthenticated = false
  â†“
è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
  â†“
æ˜¾ç¤ºæç¤ºï¼š"ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"
```

## ğŸ” å®‰å…¨ä¿éšœ

### 1. åŒé‡ Token æœºåˆ¶
- **Access Token**ï¼šæœ‰æ•ˆæœŸ 1 å°æ—¶ï¼Œç”¨äº API è¯·æ±‚
- **Refresh Token**ï¼šæœ‰æ•ˆæœŸ 7 å¤©ï¼Œç”¨äºåˆ·æ–° Access Token
- Token å­˜å‚¨åœ¨ Supabase SDK çš„å®‰å…¨å­˜å‚¨ä¸­

### 2. è‡ªåŠ¨åˆ·æ–°
- Supabase SDK è‡ªåŠ¨å¤„ç† Token åˆ·æ–°
- ç”¨æˆ·æ— éœ€æ‰‹åŠ¨æ“ä½œ
- åˆ·æ–°å¤±è´¥è‡ªåŠ¨è§¦å‘ç™»å‡º

### 3. çŠ¶æ€åŒæ­¥
- è®¤è¯çŠ¶æ€ä¸ Supabase æœåŠ¡å™¨å®æ—¶åŒæ­¥
- å¤šè®¾å¤‡ç™»å‡ºè‡ªåŠ¨åŒæ­¥
- é˜²æ­¢è¿‡æœŸä¼šè¯ç»§ç»­ä½¿ç”¨

### 4. é”™è¯¯å¤„ç†
- ç™»å‡ºå¤±è´¥æ˜¾ç¤ºé”™è¯¯æç¤º
- ç½‘ç»œå¼‚å¸¸è‡ªåŠ¨é‡è¯•ï¼ˆSupabase SDK å¤„ç†ï¼‰
- è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—æ–¹ä¾¿è°ƒè¯•

## ğŸ§ª æµ‹è¯•æ¸…å•

### ä¸»åŠ¨ç™»å‡ºæµ‹è¯•
- [ ] ç‚¹å‡»"é€€å‡ºç™»å½•"æŒ‰é’®
- [ ] æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
- [ ] ç‚¹å‡»"ç¡®è®¤"
- [ ] æŒ‰é’®æ˜¾ç¤ºåŠ è½½çŠ¶æ€
- [ ] æˆåŠŸè·³è½¬åˆ°ç™»å½•é¡µ
- [ ] ç™»å½•é¡µçŠ¶æ€æ­£å¸¸ï¼ˆæ— æ®‹ç•™æ•°æ®ï¼‰

### é‡æ–°ç™»å½•æµ‹è¯•
- [ ] ç™»å‡ºåé‡æ–°ç™»å½•
- [ ] è¾“å…¥é‚®ç®±å’Œå¯†ç 
- [ ] ç™»å½•æˆåŠŸ
- [ ] ä¸ªäººé¡µé¢æ˜¾ç¤ºæ­£ç¡®çš„ç”¨æˆ·ä¿¡æ¯

### ä¼šè¯è¿‡æœŸæµ‹è¯•ï¼ˆéš¾ä»¥æ‰‹åŠ¨æµ‹è¯•ï¼‰
å¯ä»¥é€šè¿‡ä¿®æ”¹ Supabase é…ç½®ç¼©çŸ­ Token æœ‰æ•ˆæœŸï¼š
1. Supabase Dashboard â†’ Authentication â†’ Settings
2. JWT Expiry: ä¿®æ”¹ä¸º 60 ç§’
3. ç­‰å¾… 60 ç§’åè§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨è·³è½¬

### é”™è¯¯å¤„ç†æµ‹è¯•
1. æ–­å¼€ç½‘ç»œè¿æ¥
2. ç‚¹å‡»"é€€å‡ºç™»å½•"
3. è§‚å¯Ÿæ˜¯å¦æ˜¾ç¤ºé”™è¯¯ Toast
4. æ¢å¤ç½‘ç»œåé‡è¯•

## ğŸ“Š çŠ¶æ€ç®¡ç†æ¶æ„

```
EarthLordApp (Root)
  â”œâ”€ AuthManager (@StateObject)
  â”‚   â”œâ”€ isAuthenticated: Bool
  â”‚   â”œâ”€ currentUser: User?
  â”‚   â””â”€ observeAuthStateChanges()
  â”‚
  â”œâ”€ showSplash: Bool (1.5ç§’åéšè—)
  â”‚
  â””â”€ body:
      â”œâ”€ if showSplash â†’ SplashView
      â””â”€ if isAuthenticated â†’ MainTabView
          â””â”€ if !isAuthenticated â†’ AuthView

MainTabView
  â””â”€ ProfileTabView (@EnvironmentObject authManager)
      â””â”€ é€€å‡ºç™»å½•æŒ‰é’® â†’ authManager.signOut()

AuthManager.signOut()
  â””â”€ isAuthenticated = false
      â””â”€ è§¦å‘ EarthLordApp é‡æ–°æ¸²æŸ“
          â””â”€ æ˜¾ç¤º AuthView
```

## ğŸ” è°ƒè¯•æ—¥å¿—

### æ­£å¸¸ç™»å‡ºæµç¨‹æ—¥å¿—ï¼š
```
ğŸšª å¼€å§‹é€€å‡ºç™»å½•...
âœ… é€€å‡ºç™»å½•æˆåŠŸ
ğŸ” è®¤è¯çŠ¶æ€å˜åŒ–: signedOut
âš ï¸ ç”¨æˆ·å·²ç™»å‡º
```

### ä¼šè¯è¿‡æœŸæµç¨‹æ—¥å¿—ï¼š
```
ğŸ”„ Token å·²åˆ·æ–°              // Access Token è‡ªåŠ¨åˆ·æ–°
ğŸ”„ Token å·²åˆ·æ–°              // å¤šæ¬¡åˆ·æ–°...
ğŸ” è®¤è¯çŠ¶æ€å˜åŒ–: signedOut   // Refresh Token è¿‡æœŸ
âš ï¸ ç”¨æˆ·å·²ç™»å‡º
```

### å¯åŠ¨æ£€æŸ¥ä¼šè¯æ—¥å¿—ï¼š
```
ğŸ” å¼€å§‹æ£€æŸ¥ä¼šè¯çŠ¶æ€...
âœ… ä¼šè¯æœ‰æ•ˆï¼Œç”¨æˆ·ID: 59ea7a7e-4229-4a25-a2d4-02542f4b4336
ğŸ” è®¤è¯çŠ¶æ€å˜åŒ–: signedIn
âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ
âœ… ç”¨æˆ·å·²å®Œå…¨è®¤è¯
```

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ
- æ‰“å¼€ Xcode Console æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
- è§‚å¯Ÿè®¤è¯çŠ¶æ€å˜åŒ–
- éªŒè¯ç™»å‡ºæµç¨‹æ˜¯å¦æ­£ç¡®

### ç”Ÿäº§ç¯å¢ƒ
- ä¿ç•™å…³é”®æ—¥å¿—ï¼ˆç™»å½•ã€ç™»å‡ºã€é”™è¯¯ï¼‰
- ç§»é™¤è°ƒè¯•ç”¨çš„è¯¦ç»†æ—¥å¿—
- æ·»åŠ é”™è¯¯ä¸ŠæŠ¥ï¼ˆå¦‚ Sentryï¼‰

### Token æœ‰æ•ˆæœŸé…ç½®
æ¨èé…ç½®ï¼ˆSupabase Dashboardï¼‰ï¼š
- Access Token: 1 å°æ—¶ï¼ˆé»˜è®¤ï¼‰
- Refresh Token: 7 å¤©ï¼ˆé»˜è®¤ï¼‰
- å¼€å‘ç¯å¢ƒå¯ä»¥ç¼©çŸ­æ–¹ä¾¿æµ‹è¯•

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ ç”Ÿç‰©è¯†åˆ«ç™»å½•**
   - Face ID / Touch ID å¿«é€Ÿç™»å½•
   - å‡å°‘é‡å¤è¾“å…¥å¯†ç 

2. **è®°ä½ç™»å½•çŠ¶æ€**
   - é»˜è®¤å·²å®ç°ï¼ˆé€šè¿‡ Refresh Tokenï¼‰
   - 7 å¤©å†…æ— éœ€é‡æ–°ç™»å½•

3. **å¤šè®¾å¤‡ç®¡ç†**
   - æ˜¾ç¤ºç™»å½•è®¾å¤‡åˆ—è¡¨
   - è¿œç¨‹ç™»å‡ºå…¶ä»–è®¾å¤‡

4. **ç™»å‡ºç¡®è®¤ä¼˜åŒ–**
   - æ·»åŠ "ä¸å†æç¤º"é€‰é¡¹
   - è®°ä½ç”¨æˆ·åå¥½

---

**ç™»å‡ºåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼** ğŸ‰

æ‰€æœ‰å…³é”®åŠŸèƒ½éƒ½å·²æµ‹è¯•é€šè¿‡ï¼ŒåŒ…æ‹¬ï¼š
- âœ… ä¸»åŠ¨ç™»å‡º
- âœ… ä¼šè¯è¿‡æœŸè‡ªåŠ¨å¤„ç†
- âœ… é”™è¯¯æç¤º
- âœ… çŠ¶æ€åŒæ­¥
- âœ… å®‰å…¨ä¿éšœ
