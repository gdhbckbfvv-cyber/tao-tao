# åœ°çƒæ–°ä¸» - å®Œæ•´è®¤è¯æµç¨‹è¯´æ˜

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### âœ… 1. å¯åŠ¨ç”»é¢ (SplashView.swift)
- Logo å’Œæ ‡é¢˜å±•ç¤º
- å‘¼å¸åŠ¨ç”»æ•ˆæœ
- ä¸‰ç‚¹åŠ è½½åŠ¨ç”»
- è‡ªåŠ¨æ£€æŸ¥ä¼šè¯çŠ¶æ€
- 1.5ç§’åè‡ªåŠ¨éšè—

### âœ… 2. è®¤è¯çŠ¶æ€ç›‘å¬ (AuthManager.swift)
- ç›‘å¬ `supabase.auth.authStateChanges`
- è‡ªåŠ¨å“åº”ç™»å½•/ç™»å‡ºäº‹ä»¶
- å¤„ç† token åˆ·æ–°
- å¤„ç†å¯†ç æ¢å¤æµç¨‹

### âœ… 3. å®Œæ•´çš„é¡µé¢æµè½¬ (EarthLordApp.swift)
- å¯åŠ¨æ—¶æ˜¾ç¤º SplashView
- æ ¹æ®è®¤è¯çŠ¶æ€è‡ªåŠ¨åˆ‡æ¢é¡µé¢
- å¹³æ»‘çš„è¿‡æ¸¡åŠ¨ç”»

## ğŸ“± å®Œæ•´æµç¨‹æ¼”ç¤º

### åº”ç”¨å¯åŠ¨æµç¨‹
```
App å¯åŠ¨
  â†“
SplashView (1.5ç§’)
  â”œâ”€ æ˜¾ç¤º Logo å’ŒåŠ¨ç”»
  â”œâ”€ è°ƒç”¨ checkSession()
  â””â”€ æ£€æŸ¥ä¼šè¯çŠ¶æ€
  â†“
æ·¡å‡ºåŠ¨ç”» (0.3ç§’)
  â†“
æ ¹æ® isAuthenticated æ˜¾ç¤ºä¸åŒé¡µé¢
  â”œâ”€ true  â†’ MainTabView (ä¸»é¡µ)
  â””â”€ false â†’ AuthView (ç™»å½•/æ³¨å†Œ)
```

### é¦–æ¬¡ä½¿ç”¨ï¼ˆæ— ä¼šè¯ï¼‰
```
SplashView
  â†“ checkSession() è¿”å›æ— ä¼šè¯
  â†“
AuthView (æ³¨å†ŒTab)
  â†“ ç”¨æˆ·æ³¨å†Œ
  â”œâ”€ è¾“å…¥é‚®ç®±
  â”œâ”€ éªŒè¯ OTP
  â””â”€ è®¾ç½®å¯†ç 
  â†“
è§¦å‘ .signedIn äº‹ä»¶
  â†“ authManager.isAuthenticated = true
  â†“
è‡ªåŠ¨åˆ‡æ¢åˆ° MainTabView
```

### å·²ç™»å½•ç”¨æˆ·
```
SplashView
  â†“ checkSession() æ‰¾åˆ°æœ‰æ•ˆä¼šè¯
  â†“ è§¦å‘ .signedIn äº‹ä»¶
  â†“ authManager.isAuthenticated = true
  â†“
è‡ªåŠ¨åˆ‡æ¢åˆ° MainTabView
```

### ç”¨æˆ·ç™»å‡º
```
ç”¨æˆ·ç‚¹å‡»"é€€å‡ºç™»å½•"
  â†“
authManager.signOut()
  â†“
è§¦å‘ .signedOut äº‹ä»¶
  â†“ authManager.isAuthenticated = false
  â†“
è‡ªåŠ¨åˆ‡æ¢åˆ° AuthView
```

## ğŸ”„ è®¤è¯çŠ¶æ€äº‹ä»¶å¤„ç†

### AuthManager ç›‘å¬çš„äº‹ä»¶

| äº‹ä»¶ | è§¦å‘æ—¶æœº | å¤„ç†æ–¹å¼ |
|------|---------|---------|
| `.signedIn` | ç”¨æˆ·ç™»å½•æˆåŠŸ | è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè®¾ç½® `isAuthenticated = true` |
| `.signedOut` | ç”¨æˆ·ç™»å‡º | æ¸…ç©ºæ‰€æœ‰çŠ¶æ€ï¼Œè®¾ç½® `isAuthenticated = false` |
| `.userUpdated` | ç”¨æˆ·ä¿¡æ¯æ›´æ–° | é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯ |
| `.passwordRecovery` | å¯†ç æ¢å¤æµç¨‹ | è®¾ç½® `needsPasswordSetup = true` |
| `.tokenRefreshed` | Token è‡ªåŠ¨åˆ·æ–° | æ— éœ€å¤„ç† |
| `.userDeleted` | ç”¨æˆ·åˆ é™¤ | æ¸…ç©ºç”¨æˆ·ä¿¡æ¯ |

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
EarthLord/
â”œâ”€â”€ EarthLordApp.swift                 âœ… æ›´æ–°ï¼ˆé›†æˆè®¤è¯æµç¨‹ï¼‰
â”œâ”€â”€ Models/
â”‚   â””â”€â”€ User.swift                     âœ… ç”¨æˆ·æ¨¡å‹
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ SupabaseConfig.swift           âœ… Supabase é…ç½®
â”‚   â””â”€â”€ AuthManager.swift              âœ… æ›´æ–°ï¼ˆæ·»åŠ çŠ¶æ€ç›‘å¬ï¼‰
â””â”€â”€ Views/
    â”œâ”€â”€ SplashView.swift               âœ… æ–°å¢ï¼ˆå¯åŠ¨ç”»é¢ï¼‰
    â”œâ”€â”€ Auth/
    â”‚   â””â”€â”€ AuthView.swift             âœ… è®¤è¯é¡µé¢
    â”œâ”€â”€ RootView.swift                 âœ… åŸå¯åŠ¨é¡µï¼ˆç°ä¸ºä¸»é¡µæ ¹è§†å›¾ï¼‰
    â””â”€â”€ MainTabView.swift              âœ… ä¸» Tab å¯¼èˆª
```

## ğŸ¨ è§†è§‰æ•ˆæœ

### SplashView
- æ·±è‰²æ¸å˜èƒŒæ™¯ï¼ˆç´«é»‘è‰²è°ƒï¼‰
- Logo å…¥åœºåŠ¨ç”»ï¼ˆç¼©æ”¾ + æ·¡å…¥ï¼‰
- å‘¼å¸å…‰æ™•æ•ˆæœ
- ä¸‰ç‚¹è·³åŠ¨åŠ è½½åŠ¨ç”»
- åŠ è½½çŠ¶æ€æ–‡å­—æç¤º

### é¡µé¢åˆ‡æ¢
- æ·¡å…¥æ·¡å‡ºåŠ¨ç”»ï¼ˆ0.3ç§’ï¼‰
- å¹³æ»‘çš„è§†è§‰è¿‡æ¸¡
- æ— é—ªçƒå’Œè·³è·ƒ

## ğŸ’» ä»£ç ç¤ºä¾‹

### 1. å¯åŠ¨æ—¶æ£€æŸ¥ä¼šè¯

```swift
// SplashView.swift
.task {
    await checkSession()
}

private func checkSession() async {
    loadingText = "æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€..."
    await authManager.checkSession()
    loadingText = "å‡†å¤‡å°±ç»ª"
}
```

### 2. ç›‘å¬è®¤è¯çŠ¶æ€

```swift
// AuthManager.swift
init(supabase: SupabaseClient) {
    self.supabase = supabase
    Task {
        await observeAuthStateChanges()
    }
}

private func observeAuthStateChanges() async {
    for await state in supabase.auth.authStateChanges {
        handleAuthStateChange(state)
    }
}
```

### 3. æ ¹æ®çŠ¶æ€åˆ‡æ¢é¡µé¢

```swift
// EarthLordApp.swift
if authManager.isAuthenticated {
    MainTabView()
        .environmentObject(authManager)
} else {
    AuthView()
        .environmentObject(authManager)
}
```

### 4. åœ¨ä»»æ„é¡µé¢é€€å‡ºç™»å½•

```swift
struct ProfileView: View {
    @EnvironmentObject var authManager: AuthManager

    var body: some View {
        Button("é€€å‡ºç™»å½•") {
            Task {
                await authManager.signOut()
                // è‡ªåŠ¨è§¦å‘ .signedOut äº‹ä»¶
                // è‡ªåŠ¨åˆ‡æ¢åˆ° AuthView
            }
        }
    }
}
```

## ğŸ” å®‰å…¨æ€§ä¿éšœ

### 1. Session è‡ªåŠ¨ç®¡ç†
- Supabase SDK è‡ªåŠ¨å¤„ç† token åˆ·æ–°
- è¿‡æœŸ token è‡ªåŠ¨è§¦å‘é‡æ–°ç™»å½•

### 2. çŠ¶æ€åŒæ­¥
- è®¤è¯çŠ¶æ€ä¸ Supabase å®æ—¶åŒæ­¥
- å¤šè®¾å¤‡ç™»å‡ºè‡ªåŠ¨åŒæ­¥

### 3. å¯†ç ä¿æŠ¤
- OTP éªŒè¯æˆåŠŸåå¿…é¡»è®¾ç½®å¯†ç 
- `needsPasswordSetup` æ ‡å¿—é˜²æ­¢è·³è¿‡å¯†ç è®¾ç½®

## âš™ï¸ é…ç½®è¯´æ˜

### Supabase Email æ¨¡æ¿

éœ€è¦åœ¨ Supabase Dashboard é…ç½®ä»¥ä¸‹é‚®ä»¶æ¨¡æ¿ï¼š

1. **Magic Linkï¼ˆæ³¨å†ŒéªŒè¯ç ï¼‰**
   - Settings â†’ Auth â†’ Email Templates â†’ Magic Link
   - ç¡®ä¿åŒ…å« `{{ .Token }}` å ä½ç¬¦

2. **Reset Passwordï¼ˆå¯†ç é‡ç½®ï¼‰**
   - Settings â†’ Auth â†’ Email Templates â†’ Change Email Address
   - ç¡®ä¿åŒ…å« `{{ .Token }}` å ä½ç¬¦

### æ—¶é—´é…ç½®

| é¡¹ç›® | æ—¶é—´ | è¯´æ˜ |
|-----|------|------|
| SplashView æ˜¾ç¤ºæ—¶é•¿ | 1.5ç§’ | å¯åœ¨ EarthLordApp.swift ä¸­è°ƒæ•´ |
| é¡µé¢åˆ‡æ¢åŠ¨ç”» | 0.3ç§’ | å¯åœ¨ EarthLordApp.swift ä¸­è°ƒæ•´ |
| OTP å€’è®¡æ—¶ | 60ç§’ | å¯åœ¨ AuthView.swift ä¸­è°ƒæ•´ |

## ğŸ› è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹è®¤è¯äº‹ä»¶

åœ¨ `handleAuthStateChange` æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—ï¼š

```swift
private func handleAuthStateChange(_ state: AuthChangeEvent) {
    print("ğŸ” Auth State Changed: \(state)")
    // ... å…¶ä»–ä»£ç 
}
```

### æŸ¥çœ‹ä¼šè¯çŠ¶æ€

åœ¨ `checkSession` æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—ï¼š

```swift
func checkSession() async {
    print("ğŸ” Checking session...")
    do {
        let session = try await supabase.auth.session
        print("âœ… Session found: \(session.user.id)")
    } catch {
        print("âŒ No session: \(error)")
    }
}
```

## ğŸ¯ æµ‹è¯•æ¸…å•

### é¦–æ¬¡å¯åŠ¨
- [ ] æ˜¾ç¤º SplashView
- [ ] 1.5ç§’ååˆ‡æ¢åˆ° AuthView
- [ ] æ³¨å†Œæµç¨‹æ­£å¸¸

### å·²ç™»å½•ç”¨æˆ·
- [ ] æ˜¾ç¤º SplashView
- [ ] è‡ªåŠ¨æ£€æŸ¥ä¼šè¯
- [ ] 1.5ç§’ååˆ‡æ¢åˆ° MainTabView
- [ ] ç”¨æˆ·ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º

### ç™»å‡ºæµ‹è¯•
- [ ] ç‚¹å‡»é€€å‡ºç™»å½•
- [ ] è‡ªåŠ¨åˆ‡æ¢åˆ° AuthView
- [ ] é‡æ–°ç™»å½•æ­£å¸¸

### å¯†ç é‡ç½®
- [ ] å‘é€éªŒè¯ç æˆåŠŸ
- [ ] éªŒè¯ç éªŒè¯æˆåŠŸ
- [ ] è®¾ç½®æ–°å¯†ç æˆåŠŸ
- [ ] è‡ªåŠ¨åˆ‡æ¢åˆ° MainTabView

### ä¼šè¯è¿‡æœŸ
- [ ] Token è¿‡æœŸåè‡ªåŠ¨åˆ·æ–°
- [ ] æˆ–è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

## ğŸš€ éƒ¨ç½²å‰æ£€æŸ¥

- [ ] æ‰€æœ‰æ–‡ä»¶å·²æ·»åŠ åˆ° Xcode é¡¹ç›®
- [ ] Supabase é‚®ä»¶æ¨¡æ¿å·²é…ç½®
- [ ] æµ‹è¯•æ‰€æœ‰è®¤è¯æµç¨‹
- [ ] æ£€æŸ¥åŠ¨ç”»æµç•…åº¦
- [ ] éªŒè¯é”™è¯¯æç¤ºæ­£ç¡®
- [ ] æµ‹è¯•ç½‘ç»œå¼‚å¸¸æƒ…å†µ

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**
   - é¢„åŠ è½½ç”¨æˆ·èµ„æ–™æ•°æ®
   - ä¼˜åŒ–åŠ¨ç”»æ€§èƒ½

2. **ç”¨æˆ·ä½“éªŒ**
   - æ·»åŠ éª¨æ¶å±
   - æ·»åŠ é”™è¯¯é‡è¯•æœºåˆ¶
   - è®°ä½ä¸Šæ¬¡ç™»å½•çš„é‚®ç®±

3. **å®‰å…¨å¢å¼º**
   - æ·»åŠ ç”Ÿç‰©è¯†åˆ«ç™»å½•
   - å®ç°è®¾å¤‡ç®¡ç†
   - æ·»åŠ ç™»å½•å†å²è®°å½•

4. **ç¬¬ä¸‰æ–¹ç™»å½•**
   - å®ç° Apple ç™»å½•
   - å®ç° Google ç™»å½•
   - å®ç°å¾®ä¿¡ç™»å½•

---

**ç°åœ¨åº”ç”¨å·²å…·å¤‡å®Œæ•´çš„è®¤è¯æµç¨‹ï¼** ğŸ‰

å¯åŠ¨æµç•…ï¼ŒçŠ¶æ€ç®¡ç†å®Œå–„ï¼Œç”¨æˆ·ä½“éªŒä¼˜ç§€ï¼
