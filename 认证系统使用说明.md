# åœ°çƒæ–°ä¸» - è®¤è¯ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## ğŸ“ å·²åˆ›å»ºçš„æ–‡ä»¶

```
EarthLord/
â”œâ”€â”€ Models/
â”‚   â””â”€â”€ User.swift                         # ç”¨æˆ·æ¨¡å‹
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ SupabaseConfig.swift               # Supabase é…ç½®
â”‚   â””â”€â”€ AuthManager.swift                  # è®¤è¯ç®¡ç†å™¨
â”œâ”€â”€ Views/
â”‚   â””â”€â”€ Auth/
â”‚       â””â”€â”€ AuthView.swift                 # è®¤è¯é¡µé¢
â””â”€â”€ EarthLordApp.swift                     # App å…¥å£ï¼ˆå·²æ›´æ–°ï¼‰
```

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. ç™»å½•åŠŸèƒ½
- âœ… é‚®ç®± + å¯†ç ç™»å½•
- âœ… "å¿˜è®°å¯†ç "é“¾æ¥
- âœ… è¾“å…¥éªŒè¯
- âœ… é”™è¯¯æç¤º

### 2. æ³¨å†Œæµç¨‹ï¼ˆä¸‰æ­¥ï¼‰

#### ç¬¬ä¸€æ­¥ï¼šé‚®ç®±éªŒè¯
- è¾“å…¥é‚®ç®±
- ç‚¹å‡»"å‘é€éªŒè¯ç "
- è°ƒç”¨ `authManager.sendRegisterOTP(email:)`

#### ç¬¬äºŒæ­¥ï¼šéªŒè¯ç éªŒè¯
- è¾“å…¥6ä½éªŒè¯ç 
- 60ç§’å€’è®¡æ—¶
- å¯é‡æ–°å‘é€
- è°ƒç”¨ `authManager.verifyRegisterOTP(email:code:)`
- âš ï¸ éªŒè¯æˆåŠŸåç”¨æˆ·å·²ç™»å½•ï¼Œä½†è¿˜éœ€å®Œæˆç¬¬ä¸‰æ­¥

#### ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®å¯†ç 
- è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰
- ç¡®è®¤å¯†ç 
- è°ƒç”¨ `authManager.completeRegistration(password:)`
- âœ… å®Œæˆåè‡ªåŠ¨è¿›å…¥ä¸»é¡µ

### 3. æ‰¾å›å¯†ç æµç¨‹

#### é€šè¿‡å¼¹çª—å®ç°ï¼Œä¸‰æ­¥æµç¨‹ï¼š
1. è¾“å…¥é‚®ç®±ï¼Œå‘é€éªŒè¯ç 
2. éªŒè¯éªŒè¯ç 
3. è®¾ç½®æ–°å¯†ç 

### 4. ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆé¢„ç•™ï¼‰
- Apple ç™»å½•æŒ‰é’®ï¼ˆç‚¹å‡»æ˜¾ç¤º"å³å°†å¼€æ”¾"ï¼‰
- Google ç™»å½•æŒ‰é’®ï¼ˆç‚¹å‡»æ˜¾ç¤º"å³å°†å¼€æ”¾"ï¼‰

## ğŸ¨ UI è®¾è®¡

### é…è‰²æ–¹æ¡ˆ
- èƒŒæ™¯ï¼šæ·±è‰²æ¸å˜ï¼ˆç´«é»‘è‰²è°ƒï¼‰
- ä¸»é¢˜è‰²ï¼šæ©™è‰²ï¼ˆ`ApocalypseTheme.primary`ï¼‰
- å¡ç‰‡èƒŒæ™¯ï¼šæ·±ç°è‰²ï¼ˆ`ApocalypseTheme.cardBackground`ï¼‰
- æ–‡å­—ï¼šç™½è‰²/ç°è‰²

### ç»„ä»¶
- âœ… **CustomTextField** - å¸¦å›¾æ ‡çš„è¾“å…¥æ¡†
- âœ… **CustomSecureField** - å¯†ç è¾“å…¥æ¡†
- âœ… **OTPInputField** - 6ä½éªŒè¯ç è¾“å…¥ï¼ˆUIæ˜¾ç¤º6ä¸ªæ–¹æ¡†ï¼‰
- âœ… **StepIndicator** - æ­¥éª¤æŒ‡ç¤ºå™¨ï¼ˆå°åœ†ç‚¹ï¼‰
- âœ… **Loading Overlay** - åŠ è½½é®ç½©
- âœ… **Toast** - æç¤ºæ¶ˆæ¯

## ğŸ“± ä½¿ç”¨æµç¨‹

### åº”ç”¨å¯åŠ¨
1. App å¯åŠ¨æ—¶è‡ªåŠ¨è°ƒç”¨ `authManager.checkSession()`
2. å¦‚æœæœ‰æœ‰æ•ˆä¼šè¯ï¼Œç›´æ¥è¿›å…¥ä¸»é¡µ
3. å¦åˆ™æ˜¾ç¤ºç™»å½•/æ³¨å†Œé¡µé¢

### ç”¨æˆ·æ³¨å†Œ
```
AuthView (æ³¨å†ŒTab)
â†’ è¾“å…¥é‚®ç®± â†’ å‘é€éªŒè¯ç 
â†’ è¾“å…¥éªŒè¯ç  â†’ éªŒè¯ï¼ˆç”¨æˆ·å·²ç™»å½•ï¼‰
â†’ è®¾ç½®å¯†ç  â†’ å®Œæˆæ³¨å†Œ
â†’ è‡ªåŠ¨è·³è½¬åˆ° MainTabView
```

### ç”¨æˆ·ç™»å½•
```
AuthView (ç™»å½•Tab)
â†’ è¾“å…¥é‚®ç®±+å¯†ç  â†’ ç™»å½•
â†’ è‡ªåŠ¨è·³è½¬åˆ° MainTabView
```

### æ‰¾å›å¯†ç 
```
AuthView â†’ ç‚¹å‡»"å¿˜è®°å¯†ç ï¼Ÿ"
â†’ å¼¹å‡ºæ‰¾å›å¯†ç é¡µé¢
â†’ è¾“å…¥é‚®ç®± â†’ å‘é€éªŒè¯ç 
â†’ è¾“å…¥éªŒè¯ç  â†’ éªŒè¯
â†’ è®¾ç½®æ–°å¯†ç  â†’ å®Œæˆé‡ç½®
â†’ è‡ªåŠ¨è·³è½¬åˆ° MainTabView
```

## ğŸ”‘ å…³é”®çŠ¶æ€ç®¡ç†

### AuthManager çŠ¶æ€
- `isAuthenticated` - æ˜¯å¦å®Œå…¨è®¤è¯ï¼ˆæ§åˆ¶æ˜¾ç¤ºä¸»é¡µè¿˜æ˜¯ç™»å½•é¡µï¼‰
- `needsPasswordSetup` - æ˜¯å¦éœ€è¦è®¾ç½®å¯†ç ï¼ˆOTPéªŒè¯åï¼‰
- `otpVerified` - éªŒè¯ç æ˜¯å¦å·²éªŒè¯
- `otpSent` - éªŒè¯ç æ˜¯å¦å·²å‘é€
- `isLoading` - åŠ è½½çŠ¶æ€
- `errorMessage` - é”™è¯¯ä¿¡æ¯

### é¡µé¢çŠ¶æ€
- `selectedTab` - å½“å‰ Tabï¼ˆç™»å½•/æ³¨å†Œï¼‰
- `registerStep` - æ³¨å†Œæµç¨‹æ­¥éª¤ï¼ˆ1/2/3ï¼‰
- `forgotStep` - æ‰¾å›å¯†ç æ­¥éª¤ï¼ˆ1/2/3ï¼‰
- `otpCountdown` - éªŒè¯ç å€’è®¡æ—¶
- `showForgotPassword` - æ˜¯å¦æ˜¾ç¤ºæ‰¾å›å¯†ç å¼¹çª—

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æ³¨å†Œæµç¨‹çš„å…³é”®ç‚¹
```swift
// ç¬¬äºŒæ­¥éªŒè¯æˆåŠŸå
authManager.otpVerified = true  // âœ… éªŒè¯æˆåŠŸ
authManager.needsPasswordSetup = true  // âš ï¸ ä½†éœ€è¦è®¾ç½®å¯†ç 
// æ­¤æ—¶ isAuthenticated ä»ä¸º falseï¼Œå¿…é¡»å®Œæˆç¬¬ä¸‰æ­¥ï¼

// ç¬¬ä¸‰æ­¥å¯†ç è®¾ç½®å®Œæˆå
authManager.isAuthenticated = true  // âœ… ç°åœ¨æ‰èƒ½è¿›å…¥ä¸»é¡µ
```

### 2. OTP ç±»å‹åŒºåˆ†
- **æ³¨å†ŒéªŒè¯ç **ï¼š`type: .email`
- **å¯†ç é‡ç½®**ï¼š`type: .recovery`ï¼ˆä¸è¦ææ··ï¼ï¼‰

### 3. å¯†ç éªŒè¯è§„åˆ™
- æœ€å°‘6ä½å­—ç¬¦
- ä¸¤æ¬¡è¾“å…¥å¿…é¡»ä¸€è‡´
- å®æ—¶éªŒè¯ï¼Œä¸ç¬¦åˆè§„åˆ™æ—¶æŒ‰é’®ç¦ç”¨

### 4. å€’è®¡æ—¶å¤„ç†
- å‘é€éªŒè¯ç åå¯åŠ¨60ç§’å€’è®¡æ—¶
- å€’è®¡æ—¶æœŸé—´"é‡æ–°å‘é€"æŒ‰é’®ç¦ç”¨
- å€’è®¡æ—¶ç»“æŸåå¯é‡æ–°å‘é€

## ğŸ› é”™è¯¯å¤„ç†

æ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½åŒ…å«é”™è¯¯å¤„ç†ï¼š
```swift
Task {
    await authManager.someMethod()
    // authManager.errorMessage ä¼šè‡ªåŠ¨æ›´æ–°
}

// UI è‡ªåŠ¨æ˜¾ç¤ºé”™è¯¯
.onChange(of: authManager.errorMessage) { _, error in
    if let error = error {
        showToastMessage(error)
    }
}
```

## ğŸ”„ çŠ¶æ€é‡ç½®

åˆ‡æ¢ Tab æˆ–å–æ¶ˆæ“ä½œæ—¶é‡ç½®çŠ¶æ€ï¼š
```swift
authManager.resetState()  // é‡ç½® AuthManager çŠ¶æ€
resetForgotPasswordForm()  // é‡ç½®æ‰¾å›å¯†ç è¡¨å•
```

## ğŸš€ ä¸‹ä¸€æ­¥å¼€å‘

1. **åœ¨ Xcode ä¸­æ·»åŠ æ–‡ä»¶**
   - å°† Modelsã€Servicesã€Views/Auth æ–‡ä»¶å¤¹æ·»åŠ åˆ°é¡¹ç›®

2. **é…ç½® Supabase Email Templates**
   - ç™»å½• Supabase Dashboard
   - Settings â†’ Auth â†’ Email Templates
   - é…ç½® "Magic Link" å’Œ "Change Email Address" æ¨¡æ¿

3. **æµ‹è¯•æµç¨‹**
   - æµ‹è¯•æ³¨å†Œæµç¨‹ï¼ˆå®Œæ•´ä¸‰æ­¥ï¼‰
   - æµ‹è¯•ç™»å½•æµç¨‹
   - æµ‹è¯•æ‰¾å›å¯†ç æµç¨‹
   - æµ‹è¯•ä¼šè¯æ¢å¤

4. **å¢å¼ºåŠŸèƒ½**
   - æ·»åŠ é‚®ç®±æ ¼å¼å®æ—¶éªŒè¯
   - æ·»åŠ å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨
   - å®ç° Apple/Google ç™»å½•
   - æ·»åŠ ç”Ÿç‰©è¯†åˆ«ç™»å½•ï¼ˆFace ID/Touch IDï¼‰

## ğŸ“– ä»£ç ç¤ºä¾‹

### åœ¨å…¶ä»–è§†å›¾ä¸­ä½¿ç”¨ AuthManager

```swift
struct ProfileView: View {
    @EnvironmentObject var authManager: AuthManager

    var body: some View {
        VStack {
            if let user = authManager.currentUser {
                Text("æ¬¢è¿ï¼Œ\(user.username ?? "ç”¨æˆ·")")
            }

            Button("é€€å‡ºç™»å½•") {
                Task {
                    await authManager.signOut()
                }
            }
        }
    }
}
```

### è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

```swift
if let user = authManager.currentUser {
    print("ç”¨æˆ·ID: \(user.id)")
    print("é‚®ç®±: \(user.email ?? "")")
    print("ç”¨æˆ·å: \(user.username ?? "")")
}
```

## ğŸ¯ UI é¢„è§ˆ

è¿è¡Œé¡¹ç›®åä½ å°†çœ‹åˆ°ï¼š

1. **å¯åŠ¨é¡µ** - 2.5ç§’å‘¼å¸åŠ¨ç”»
2. **è®¤è¯é¡µ** - ç™»å½•/æ³¨å†Œ Tab åˆ‡æ¢
3. **æ³¨å†Œæµç¨‹** - ä¸‰æ­¥å¼•å¯¼å¼æ³¨å†Œ
4. **ä¸»é¡µ** - è®¤è¯æˆåŠŸåçš„ Tab å¯¼èˆª

æ•´ä¸ªæµç¨‹æµç•…è‡ªç„¶ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½ï¼
